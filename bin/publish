#!/bin/bash

set -e
cd "$(dirname "$0")"
cd '..'

GITHUB_ORG='grouparoo'
GITHUB_REPO='grouparoo'
BRANCH=`git rev-parse --abbrev-ref HEAD`
OLD_VERSION=`cat lerna.json | jq -r '.version'`
RELEASE_MODE=$1

## CHECK INPUTS

if [[ "$RELEASE_MODE" == "alpha" ]]
then
  PRERELEASE='true'
  LERNA_VERSION_ARGS="prerelease --exact --preid alpha --force-publish --yes"
  DIST_TAG="next"
elif [[ "$RELEASE_MODE" == "stable" ]]
then
  PRERELEASE='false'
  LERNA_VERSION_ARGS="patch --exact --force-publish --yes"
  DIST_TAG="latest"
else
  echo 'Release Mode required.  "publish alpha" or "publish stable"'
  exit 1
fi

if [[ -z "$GH_ACCESS_TOKEN" ]];then
  echo "No GH_ACCESS_TOKEN env, exiting.."
  exit 1;
fi

if [ -f ~/.npmrc ]; then
  echo "Found existing .npmrc"
else
  if [[ -z "$NPM_TOKEN" ]];then
    echo "No NPM_TOKEN or ~/.npmrc, exiting.."
    exit 1;
  else
    echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" >> ~/.npmrc
  fi
fi
echo "Using local NPM user: `npm whoami`"

if [[ $BRANCH != 'main' ]]; then
  echo "Not on 'main' branch.  Exiting"
  exit 1
fi

if [[ -n $(git status -s) ]]; then
  echo "There are uncommitted changes on this branch.  Exiting"
  exit 1
fi

echo "Publishing $RELEASE_MODE packages"
echo "Old Version: $OLD_VERSION"
echo ""

## BUMP THE VERSION & PUSH TO GITHUB

./node_modules/.bin/lerna version $LERNA_VERSION_ARGS

## PUBLISH RELEASE NOTES

NEW_VERSION=`cat lerna.json | jq -r '.version'`
echo "New Version: $NEW_VERSION"

# Update the release with the changelog
CHANGELOG_BODY=`./node_modules/.bin/lerna-changelog --from v$OLD_VERSION --to v$NEW_VERSION`
ESCAPED_CHANGELOG_BODY=`echo "$CHANGELOG_BODY" | jq -R -s -c`
sleep 10
curl -H "Authorization: token $GH_ACCESS_TOKEN" --data "{
    \"tag_name\": \"v$NEW_VERSION\",
    \"body\": $ESCAPED_CHANGELOG_BODY,
    \"prerelease\": $PRERELEASE
}" -X POST "https://api.github.com/repos/$GITHUB_ORG/$GITHUB_REPO/releases"

## BUILD PACKAGES

pnpm run -r prepare

## PUSH TO NPM

./node_modules/.bin/lerna publish from-git --concurrency 2 --ignore-scripts --dist-tag $DIST_TAG --yes

## COMPLETE

echo ""
echo "--- Version $NEW_VERSION published to $DIST_TAG tag ---"
echo ""

exit 0
