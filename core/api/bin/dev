#!/usr/bin/env bash

cd "$(dirname "$0")"
cd ..

if [ -f "../node_modules/.bin/ts-node" ]; then
  TS_NODE="../node_modules/.bin/ts-node"
  NODEMON="../node_modules/.bin/nodemon"
else
  TS_NODE="../../../../node_modules/.bin/ts-node"
  NODEMON="../../../../node_modules/.bin/nodemon"
fi

export NEXT_DEVELOPMENT_MODE=true

# in develeopment mode, often there is an orphan next.js/webpack process hanging around if the process crashes.
GROUPAROO_PIDS=`ps | grep ts-node | grep grouparoo/core | cut -f1 -d' '`
for p in $GROUPAROO_PIDS; do
  printf "stopping orphan process $p\r\n"
  kill -9 $p
done

"$NODEMON" -e js,jsx,ts,tsx --delay 2 --signal SIGTERM --ignore dist --watch ./ --watch ../../plugins/**/*.js \
"$TS_NODE" --transpile-only --log-error src/server.ts || exit 0

